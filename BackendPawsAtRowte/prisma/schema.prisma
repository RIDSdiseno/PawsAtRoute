// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" 
  url      = env("DATABASE_URL") 
}

enum Rol {
  DUEÑO
  PASEADOR
}

enum EstadoPaseo {
  PENDIENTE
  ACEPTADO
  EN_CURSO
  FINALIZADO
  CANCELADO
}

model Usuario {
  idUsuario    Int       @id @default(autoincrement())
  rut          String
  nombre       String
  apellido     String
  telefono     String
  comuna       String
  fNacimiento  DateTime?
  correo       String    @unique
  passwordHash String

  carnetIdentidad String?
  antecedentes    String?

  rol Rol

  mascotas      Mascota[]
  refreshTokens RefreshToken[]
  tarjetas      Tarjeta[]

  // Paseos
  paseosComoDuenio   Paseo[] @relation("DuenioPaseo")
  paseosComoPaseador Paseo[] @relation("PaseadorPaseo")
}

model Mascota {
  idMascota Int    @id @default(autoincrement())
  usuarioId Int
  nombre    String
  especie   String
  raza      String
  edad      Int

  usuario Usuario @relation(fields: [usuarioId], references: [idUsuario])
  paseos  Paseo[]
}

model Paseo {
  idPaseo        Int         @id @default(autoincrement())
  mascotaId      Int
  duenioId       Int
  paseadorId     Int?
  fecha          DateTime
  hora           DateTime
  duracion       Int
  lugarEncuentro String
  estado         EstadoPaseo @default(PENDIENTE)
  notas          String?

  mascota  Mascota @relation(fields: [mascotaId], references: [idMascota])
  duenio   Usuario @relation("DuenioPaseo", fields: [duenioId], references: [idUsuario])
  paseador Usuario? @relation("PaseadorPaseo", fields: [paseadorId], references: [idUsuario])
}

model Tarjeta {
  idTarjeta     Int    @id @default(autoincrement())
  userId        Int
  numero        String // En producción: tokenizado o encriptado
  nombreTitular String
  vencimiento   String // MM/AA
  cvv           String // No se almacena en producción
  tipo          String // VISA, MASTERCARD, etc.

  usuario Usuario @relation(fields: [userId], references: [idUsuario])
}

model RefreshToken {
  id                Int       @id @default(autoincrement())
  userId            Int
  rtHash            String
  createdAt         DateTime  @default(now())
  expiresAt         DateTime
  revokedAt         DateTime?
  replacedByTokenId Int?
  userAgent         String?
  ip                String?

  user Usuario @relation(fields: [userId], references: [idUsuario])

  @@index([rtHash])
  @@index([userId])
}
